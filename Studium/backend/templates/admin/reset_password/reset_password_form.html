{% extends "admin/change_form.html" %}

{% block extrahead %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const emailInput = document.querySelector('#id_email');
    const urlInput = document.querySelector('#id_url');
    let emailVerified = false;
    let checkBtn, generateBtn;

    if (emailInput) {
        checkBtn = document.createElement('button');
        checkBtn.textContent = "Проверить";
        checkBtn.type = "button";
        checkBtn.classList.add("button");
        checkBtn.style.marginLeft = "10px";

        checkBtn.addEventListener('click', function () {
            const email = emailInput.value.trim();
            if (!email) return alert("Введите email.");

            const originalText = checkBtn.textContent;
            checkBtn.textContent = "Проверка...";
            checkBtn.disabled = true;

            fetch("/admin/authentication/adminpasswordresetrequest/check-email/?email=" + encodeURIComponent(email))
                .then(r => {
                    if (!r.ok) throw new Error('Ошибка сети');
                    return r.json();
                })
                .then(data => {
                    emailVerified = data.exists;
                    if (emailVerified) {
                        alert("Email найден.");
                        if (generateBtn) generateBtn.disabled = false;
                    } else {
                        alert("Email не найден.");
                        if (generateBtn) generateBtn.disabled = true;
                    }
                })
                .catch(err => {
                    console.error("Ошибка запроса:", err);
                    alert("Ошибка проверки email.");
                    emailVerified = false;
                    if (generateBtn) generateBtn.disabled = true;
                })
                .finally(() => {
                    checkBtn.textContent = originalText;
                    checkBtn.disabled = false;
                });
        });

        emailInput.parentNode.appendChild(checkBtn);

        // Отслеживаем изменения email для сброса verified статуса
        emailInput.addEventListener('input', function() {
            if (emailVerified && emailInput.value.trim() !== emailInput.dataset.verifiedEmail) {
                emailVerified = false;
                if (generateBtn) generateBtn.disabled = true;
            }
        });
    }

    if (urlInput) {
        generateBtn = document.createElement('button');
        generateBtn.textContent = "Сгенерировать";
        generateBtn.type = "button";
        generateBtn.classList.add("button");
        generateBtn.style.marginLeft = "10px";
        generateBtn.disabled = true; // По умолчанию неактивна

        generateBtn.addEventListener('click', function () {
            const email = emailInput ? emailInput.value.trim() : '';
            if (!emailVerified || !email) {
                alert("Сначала проверьте email.");
                return;
            }

            const originalText = generateBtn.textContent;
            generateBtn.textContent = "Генерация...";
            generateBtn.disabled = true;

            fetch("/admin/authentication/adminpasswordresetrequest/generate-url/", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ email: email })
            })
                .then(r => {
                    return r.json();
                })
                .then(data => {
                    if (data.reset_url) {
                        urlInput.value = data.reset_url;
                        alert("URL успешно сгенерирован.");
                    } else {
                        console.error("Ошибка запроса:", data);
                        alert("Ошибка запроса: " + data);
                    }
                })
                .catch(err => {
                    console.error("Ошибка запроса:", err);
                })
                .finally(() => {
                    generateBtn.textContent = originalText;
                    generateBtn.disabled = !emailVerified;
                });
        });

        urlInput.parentNode.appendChild(generateBtn);
    }
});
</script>
{% endblock %}

{% block after_field_sets %}
{% endblock %}